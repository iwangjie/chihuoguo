# ğŸ—ï¸ é¡¹ç›®æ¶æ„è¯¦è§£

## æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Cloudflare Workers + Durable Objects çš„ç½‘é¡µç‰ˆå¤šäººç«é”…æ¸¸æˆï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„æ— æœåŠ¡å™¨æ¶æ„ï¼Œå®ç°äº†é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„å®æ—¶å¤šäººåœ¨çº¿ä½“éªŒã€‚

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. è¾¹ç¼˜è®¡ç®—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Edge Network                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Worker    â”‚    â”‚   Worker    â”‚    â”‚   Worker    â”‚     â”‚
â”‚  â”‚  (Region A) â”‚    â”‚  (Region B) â”‚    â”‚  (Region C) â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Durable Objects                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Table 1   â”‚    â”‚   Table 2   â”‚    â”‚   Table 3   â”‚     â”‚
â”‚  â”‚ HotPotTable â”‚    â”‚ HotPotTable â”‚    â”‚ HotPotTable â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµæ¶æ„

```
å®¢æˆ·ç«¯ (Vue.js)
    â”‚
    â”‚ HTTP Request
    â–¼
Cloudflare Worker
    â”‚
    â”‚ Route by tableId
    â–¼
Durable Object (HotPotTable)
    â”‚
    â”‚ WebSocket Upgrade
    â–¼
WebSocket Connection Pool
    â”‚
    â”‚ Game Events
    â–¼
Game State Management
    â”‚
    â”‚ Persistence
    â–¼
Durable Object Storage
```

## æŠ€æœ¯é€‰å‹ç†ç”±

### Cloudflare Workers
- **å…¨çƒåˆ†å‘**: åœ¨ 200+ ä¸ªè¾¹ç¼˜èŠ‚ç‚¹è¿è¡Œï¼Œå»¶è¿Ÿ < 10ms
- **æ— æœåŠ¡å™¨**: æ— éœ€ç®¡ç†æœåŠ¡å™¨ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹
- **æˆæœ¬æ•ˆç›Š**: æŒ‰è¯·æ±‚ä»˜è´¹ï¼Œæ— ç©ºé—²æˆæœ¬

### Durable Objects
- **å¼ºä¸€è‡´æ€§**: æ¯ä¸ªç«é”…æ¡Œæ˜¯ç‹¬ç«‹çš„æœ‰çŠ¶æ€å¯¹è±¡
- **è‡ªåŠ¨è¿ç§»**: æ ¹æ®ç”¨æˆ·ä½ç½®è‡ªåŠ¨è¿ç§»åˆ°æœ€è¿‘èŠ‚ç‚¹
- **æŒä¹…åŒ–å­˜å‚¨**: å†…ç½®äº‹åŠ¡æ€§é”®å€¼å­˜å‚¨

### Vue.js 3
- **è½»é‡çº§**: é€‚åˆåµŒå…¥åˆ° Worker å“åº”ä¸­
- **å“åº”å¼**: å®Œç¾å¤„ç†å®æ—¶æ¸¸æˆçŠ¶æ€æ›´æ–°
- **ç»„ä»¶åŒ–**: æ¸…æ™°çš„ä»£ç ç»“æ„

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. Worker å…¥å£ (worker.js)

```javascript
// ä¸»è¦èŒè´£ï¼š
// 1. è·¯ç”±è¯·æ±‚åˆ°å¯¹åº”çš„ Durable Object
// 2. æä¾›é™æ€æ–‡ä»¶æœåŠ¡
// 3. å¤„ç† API è¯·æ±‚

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    if (url.pathname.startsWith('/table/')) {
      const tableId = url.pathname.split('/')[2];
      const id = env.HOTPOT_TABLE.idFromName(tableId);
      const stub = env.HOTPOT_TABLE.get(id);
      return stub.fetch(request);
    }
    
    // ... å…¶ä»–è·¯ç”±å¤„ç†
  }
};
```

### 2. Durable Object (HotPotTable.js)

```javascript
// ä¸»è¦èŒè´£ï¼š
// 1. ç®¡ç†å•ä¸ªç«é”…æ¡Œçš„æ‰€æœ‰çŠ¶æ€
// 2. å¤„ç† WebSocket è¿æ¥
// 3. å®ç°æ¸¸æˆé€»è¾‘
// 4. çŠ¶æ€æŒä¹…åŒ–

export class HotPotTable {
  constructor(state, env) {
    this.state = state;
    this.sessions = [];
    this.gameState = {
      seats: Array(7).fill(null).map(() => ({ player: null })),
      dishes: [],
      messages: []
    };
  }
  
  async fetch(request) {
    if (request.headers.get('Upgrade') === 'websocket') {
      return this.handleWebSocket(request);
    }
    // ... å…¶ä»–å¤„ç†
  }
}
```

### 3. å‰ç«¯æ¶æ„

```javascript
// ç»„ä»¶å±‚æ¬¡ç»“æ„ï¼š
HotPotGame (æ ¹ç»„ä»¶)
â”œâ”€â”€ HotPotTable (æ¸¸æˆåœºæ™¯)
â”‚   â”œâ”€â”€ ç«é”…ç»„ä»¶
â”‚   â”œâ”€â”€ åº§ä½ç»„ä»¶ Ã— 7
â”‚   â””â”€â”€ å¿«æ·å–Šè¯ç»„ä»¶
â””â”€â”€ DishMenu (èœå•ç»„ä»¶)
    â”œâ”€â”€ é”…åº•é€‰æ‹©å™¨
    â””â”€â”€ èœå“åˆ†ç±»å±•ç¤º
```

## çŠ¶æ€ç®¡ç†

### æ¸¸æˆçŠ¶æ€ç»“æ„

```javascript
gameState = {
  seats: [
    {
      player: {
        id: 'player_123',
        name: 'ç©å®¶æ˜µç§°',
        joinedAt: 1640995200000,
        message: 'å½“å‰æ¶ˆæ¯',
        messageTime: 1640995300000
      }
    },
    // ... å…¶ä»–åº§ä½
  ],
  dishes: [
    {
      id: 'dish_456',
      name: 'æ¯›è‚š',
      category: 'é•‡åº—ä¹‹å®',
      price: 28,
      emoji: 'ğŸ¥©',
      cookingTime: 15000,
      addedBy: 'player_123',
      addedAt: 1640995400000,
      potType: 'spicy'
    },
    // ... å…¶ä»–èœå“
  ],
  messages: [] // å†å²æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
}
```

### çŠ¶æ€åŒæ­¥æœºåˆ¶

1. **å®¢æˆ·ç«¯æ“ä½œ** â†’ WebSocket æ¶ˆæ¯
2. **Durable Object å¤„ç†** â†’ æ›´æ–°å†…éƒ¨çŠ¶æ€
3. **çŠ¶æ€æŒä¹…åŒ–** â†’ Durable Object Storage
4. **å¹¿æ’­æ›´æ–°** â†’ æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯

## å®æ—¶é€šä¿¡

### WebSocket æ¶ˆæ¯æ ¼å¼

```javascript
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
{
  type: 'join|addDish|removeDish|sendMessage',
  payload: { /* å…·ä½“æ•°æ® */ }
}

// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
{
  type: 'gameState|dishesData|playerJoined|playerLeft|dishCooked|error',
  payload: { /* å…·ä½“æ•°æ® */ }
}
```

### è¿æ¥ç®¡ç†

- **è¿æ¥æ± **: Durable Object ç»´æŠ¤æ‰€æœ‰ WebSocket è¿æ¥
- **è‡ªåŠ¨é‡è¿**: å®¢æˆ·ç«¯å®ç°æŒ‡æ•°é€€é¿é‡è¿
- **å¿ƒè·³æ£€æµ‹**: å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
- **ä¼˜é›…æ–­å¼€**: ç©å®¶ç¦»å¼€æ—¶æ¸…ç†çŠ¶æ€

## æ€§èƒ½ä¼˜åŒ–

### 1. è¾¹ç¼˜è®¡ç®—ä¼˜åŠ¿
- **å°±è¿‘è®¿é—®**: ç”¨æˆ·è¿æ¥åˆ°æœ€è¿‘çš„è¾¹ç¼˜èŠ‚ç‚¹
- **å†·å¯åŠ¨ä¼˜åŒ–**: Worker å¯åŠ¨æ—¶é—´ < 5ms
- **å†…å­˜æ•ˆç‡**: æ¯ä¸ª Worker å®ä¾‹å…±äº«ä»£ç 

### 2. Durable Object ä¼˜åŒ–
- **çŠ¶æ€å±€éƒ¨æ€§**: æ¯ä¸ªæ¡Œå­ç‹¬ç«‹ï¼Œé¿å…å…¨å±€é”
- **è‡ªåŠ¨è¿ç§»**: æ ¹æ®ç”¨æˆ·åˆ†å¸ƒè‡ªåŠ¨è¿ç§»
- **å­˜å‚¨ä¼˜åŒ–**: åªæŒä¹…åŒ–å¿…è¦çŠ¶æ€

### 3. å‰ç«¯ä¼˜åŒ–
- **ç»„ä»¶æ‡’åŠ è½½**: èœå•ç»„ä»¶æŒ‰éœ€åŠ è½½
- **çŠ¶æ€ç¼“å­˜**: é¿å…é‡å¤æ¸²æŸ“
- **åŠ¨ç”»ä¼˜åŒ–**: ä½¿ç”¨ CSS åŠ¨ç”»å‡å°‘ JS è®¡ç®—

## æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•
- **æ— çŠ¶æ€ Worker**: å¯ä»¥æ— é™æ‰©å±•
- **ç‹¬ç«‹æ¡Œå­**: æ¯ä¸ªæ¡Œå­æ˜¯ç‹¬ç«‹çš„ Durable Object
- **è‡ªåŠ¨è´Ÿè½½å‡è¡¡**: Cloudflare è‡ªåŠ¨åˆ†å‘è¯·æ±‚

### åŠŸèƒ½æ‰©å±•
- **æ–°èœå“**: åœ¨ `data.js` ä¸­æ·»åŠ 
- **æ–°æ¸¸æˆæ¨¡å¼**: æ‰©å±• Durable Object é€»è¾‘
- **æ–°äº¤äº’**: æ·»åŠ æ–°çš„ WebSocket æ¶ˆæ¯ç±»å‹

## å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯
- æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½åœ¨æœåŠ¡å™¨ç«¯éªŒè¯
- é˜²æ­¢ XSS å’Œæ³¨å…¥æ”»å‡»
- é™åˆ¶æ¶ˆæ¯é•¿åº¦å’Œé¢‘ç‡

### 2. è®¿é—®æ§åˆ¶
- åŸºäº tableId çš„éš”ç¦»
- ç©å®¶åªèƒ½æ“ä½œè‡ªå·±çš„çŠ¶æ€
- é˜²æ­¢è·¨æ¡Œå­æ•°æ®æ³„éœ²

### 3. DDoS é˜²æŠ¤
- Cloudflare å†…ç½® DDoS é˜²æŠ¤
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- å¼‚å¸¸è¿æ¥æ£€æµ‹

## ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—è®°å½•
```javascript
console.log('ç©å®¶åŠ å…¥:', { playerId, playerName, tableId });
console.error('WebSocket é”™è¯¯:', error);
```

### 2. æ€§èƒ½ç›‘æ§
- Worker æ‰§è¡Œæ—¶é—´
- WebSocket è¿æ¥æ•°
- çŠ¶æ€æ›´æ–°é¢‘ç‡

### 3. è°ƒè¯•å·¥å…·
```bash
wrangler tail          # å®æ—¶æ—¥å¿—
wrangler dev           # æœ¬åœ°å¼€å‘
wrangler deploy --dry-run  # éƒ¨ç½²é¢„æ£€
```

## éƒ¨ç½²ç­–ç•¥

### 1. ç¯å¢ƒç®¡ç†
- **å¼€å‘ç¯å¢ƒ**: `wrangler dev`
- **æµ‹è¯•ç¯å¢ƒ**: `wrangler deploy --env staging`
- **ç”Ÿäº§ç¯å¢ƒ**: `wrangler deploy --env production`

### 2. ç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨ Git æ ‡ç­¾ç®¡ç†ç‰ˆæœ¬
- æ¸è¿›å¼éƒ¨ç½²ç­–ç•¥
- å›æ»šæœºåˆ¶

### 3. é…ç½®ç®¡ç†
```toml
# wrangler.toml
[env.production]
name = "hotpot-game-prod"
vars = { ENVIRONMENT = "production" }

[env.staging]
name = "hotpot-game-staging"
vars = { ENVIRONMENT = "staging" }
```

## æˆæœ¬åˆ†æ

### Cloudflare Workers å®šä»·
- **å…è´¹é¢åº¦**: 100,000 è¯·æ±‚/å¤©
- **ä»˜è´¹è®¡åˆ’**: $5/æœˆ + $0.50/ç™¾ä¸‡è¯·æ±‚
- **Durable Objects**: $0.15/ç™¾ä¸‡è¯·æ±‚ + å­˜å‚¨è´¹ç”¨

### é¢„ä¼°æˆæœ¬ï¼ˆ1000 å¹¶å‘ç”¨æˆ·ï¼‰
- Worker è¯·æ±‚: ~$10/æœˆ
- Durable Objects: ~$15/æœˆ
- å­˜å‚¨: ~$5/æœˆ
- **æ€»è®¡**: ~$30/æœˆ

## æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] æ·»åŠ æ›´å¤šèœå“å’Œé”…åº•
- [ ] å®ç°ç©å®¶ç­‰çº§ç³»ç»Ÿ
- [ ] æ·»åŠ éŸ³æ•ˆå’ŒèƒŒæ™¯éŸ³ä¹
- [ ] ç§»åŠ¨ç«¯ä½“éªŒä¼˜åŒ–

### é•¿æœŸç›®æ ‡
- [ ] AI æ™ºèƒ½æ¨èèœå“
- [ ] å¤šæˆ¿é—´ç³»ç»Ÿ
- [ ] ç¤¾äº¤åŠŸèƒ½ï¼ˆå¥½å‹ã€æ’è¡Œæ¦œï¼‰
- [ ] å•†ä¸šåŒ–åŠŸèƒ½ï¼ˆè™šæ‹Ÿè´§å¸ã€çš®è‚¤ï¼‰

## æ€»ç»“

æœ¬é¡¹ç›®å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ç°ä»£åŒ–çš„è¾¹ç¼˜è®¡ç®—æŠ€æœ¯æ„å»ºé«˜æ€§èƒ½çš„å®æ—¶å¤šäººæ¸¸æˆã€‚é€šè¿‡ Cloudflare Workers + Durable Objects çš„ç»„åˆï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **å…¨çƒä½å»¶è¿Ÿ**: è¾¹ç¼˜è®¡ç®—å¸¦æ¥çš„æ€§èƒ½ä¼˜åŠ¿
2. **å¼ºä¸€è‡´æ€§**: Durable Objects ä¿è¯çš„çŠ¶æ€ä¸€è‡´æ€§
3. **é«˜å¯ç”¨æ€§**: æ— æœåŠ¡å™¨æ¶æ„çš„å¯é æ€§
4. **æˆæœ¬æ•ˆç›Š**: æŒ‰éœ€ä»˜è´¹çš„ç»æµæ€§

è¿™ç§æ¶æ„æ¨¡å¼å¯ä»¥åº”ç”¨åˆ°æ›´å¤šçš„å®æ—¶åä½œåº”ç”¨ä¸­ï¼Œå¦‚åœ¨çº¿ç™½æ¿ã€å¤šäººç¼–è¾‘å™¨ã€å®æ—¶èŠå¤©ç­‰åœºæ™¯ã€‚